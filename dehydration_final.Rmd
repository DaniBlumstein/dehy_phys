---
title: "dehydration"
author: "Dani Blumstein"
date: "7/18/2022"
output: html_document
---

```{r}
setwd("~/Documents/UNH/metabolic chamber/dehydration")
source("functions.R")
```

bring in libs
```{r}
library(devtools)
library(tidyverse)
library(lubridate)
library(readr)
library(viridis)
library(patchwork)
library(tidyselect)
library(readxl)
library(broom)
library(cowplot)
library(DescTools)
library(ggpubr)
library(dplyr)
library(ggforce)
library(reshape2)
#install.packages("NatParksPalettes")
library(NatParksPalettes)
```

import data
electrolyte and weight data
and path to files. this should be one of the only things edited for now 
```{r}
cols <- c("yes:Male"="#0C62AF","no:Male"="#822B0F","yes:Female"="#0C62AF", "no:Female"="#822B0F")

path <- "respo_data/"
dehydration_data <- read.csv("~/Documents/UNH/metabolic chamber/dehydration/dehydration_data.csv")
electrolyte_data <- read_excel("/Users/danielleblumstein/Documents/UNH/metabolic chamber/dehydration/mouse_metadata.xlsx")
electrolyte_data$osmolality <- electrolyte_data$Na*2 + electrolyte_data$Glu/18 + electrolyte_data$BUN/2.8
electrolyte_data$Cl <- as.numeric(electrolyte_data$Cl)
electrolyte_data$AnGap <- as.numeric(electrolyte_data$AnGap)
electrolyte_data$Hb <- as.numeric(electrolyte_data$"Hb*")
electrolyte_data <- electrolyte_data[-c(1:12), ]

electrolyte_data_diet_select <- electrolyte_data[,c("H2O","sex","Na", "K", "Crea", "BUN", "Hct", "iCa", "Glu", "osmolality", "Hb", "Cl", "TCO2", "AnGap")]

electrolyte_data_diet_select <- electrolyte_data_diet_select |>
    mutate(tt = fct_cross(H2O, sex))
all_combo<-unique(electrolyte_data_diet_select$tt)

dehydration_data <- dehydration_data |>
    mutate(tt = fct_cross(H2O, sex))
all_combo<-unique(dehydration_data$tt)

#subset_thing1 <- electrolyte_data_diet_select %>% filter(sex == "M", H2O == "yes")
#subset_thing2 <- electrolyte_data_diet_select %>% filter(sex == "M", H2O == "no")
#shapiro.test(subset_thing1$AnGap)
#shapiro.test(subset_thing2$AnGap)

#t.test(subset_thing1$AnGap,subset_thing2$AnGap)
```

```{r}
plist_electro <- list()

all_electro_T <- melt(electrolyte_data_diet_select, id.vars = c("H2O","sex", "tt"), variable.name = "electro")

my_comparisons <- list( c("yes:Male", "no:Male"), c("yes:Female", "no:Female"), c("yes:Male", "yes:Female"), c("no:Male", "no:Female"))

all_electro_s <- subset(all_electro_T, all_electro_T$electro == "Na")
ylim <- max(all_electro_s$value, na.rm = TRUE)
plist_electro[["Na"]] <-all_electro_s %>%
  ggplot(aes(x=tt, y=value, fill=tt),na.rm = FALSE) +
  geom_violin(width=1, size=0.5, alpha = 0.8) +
  stat_compare_means(comparisons = my_comparisons)+
  scale_fill_manual(values=cols, name = "Treatments")+
  geom_sina(alpha=0.5)+
  theme_classic()+
  theme(legend.position = "none", plot.title = element_text(face = "bold", size = (15),hjust = 0.5)) +
  xlab("")+
  ylab("mmol/L")+
  ggtitle("Na")+
  expand_limits(y=c(NA, ylim+2))
#save("Na", 13,10, plist_electro[["Na"]])

all_electro_s <- subset(all_electro_T, all_electro_T$electro == "K")
ylim <- max(all_electro_s$value, na.rm = TRUE)
plist_electro[["K"]] <-all_electro_s %>%
  ggplot(aes(x=tt, y=value, fill=tt),na.rm = FALSE) +
  geom_violin(width=1, size=0.5, alpha = 0.8) +
  stat_compare_means(comparisons = my_comparisons)+
  scale_fill_manual(values=cols, name = "Treatments")+
  geom_sina(alpha=0.5)+
  theme_classic()+
  theme(legend.position = "none", plot.title = element_text(face = "bold", size = (15),hjust = 0.5)) +
  xlab("")+
  ylab("mmol/L")+
  ggtitle("K")
#save("K", 13,10, plist_electro[["K"]])

#all_electro_s <- subset(all_electro_T, all_electro_T$electro == "Crea")
#ylim <- .207
#plist_electro[["Crea"]] <-all_electro_s %>%
#  ggplot(aes(x=tt, y=value, fill=tt),na.rm = FALSE) +
#  geom_violin(width=1, size=0.5, alpha = 0.8) +
#  stat_compare_means(comparisons = my_comparisons)+
#  scale_fill_manual(values=cols, name = "Treatments")+
#  geom_sina(alpha=0.5)+
#  theme_classic()+
#  theme(legend.position = "none", plot.title = element_text(face = "bold", size = #(15),hjust = 0.5)) +
#  xlab("")+
#  ylab("umol/L")+
#  scale_y_continuous(labels = scales::number_format(accuracy = 0.01))+
#  ggtitle("Crea")
#save("Crea", 13,10, plist_electro[["Crea"]])

all_electro_s <- subset(all_electro_T, all_electro_T$electro == "BUN")
ylim <- max(all_electro_s$value, na.rm = TRUE)
plist_electro[["BUN"]] <-all_electro_s %>%
  ggplot(aes(x=tt, y=value, fill=tt),na.rm = FALSE) +
  geom_violin(width=1, size=0.5, alpha = 0.8) +
  stat_compare_means(comparisons = my_comparisons)+
  scale_fill_manual(values=cols, name = "Treatments")+
  geom_sina(alpha=0.5)+
  theme_classic()+
  theme(legend.position = "none", plot.title = element_text(face = "bold", size = (15),hjust = 0.5)) +
  xlab("")+
  ylab("mmol/L")+
  ggtitle("BUN")
#save("BUN", 13,10, plist_electro[["BUN"]])

all_electro_s <- subset(all_electro_T, all_electro_T$electro == "Hct")
ylim <- max(all_electro_s$value, na.rm = TRUE)
plist_electro[["Hct"]] <-all_electro_s %>%
  ggplot(aes(x=tt, y=value, fill=tt),na.rm = FALSE) +
  geom_violin(width=1, size=0.5, alpha = 0.8) +
  stat_compare_means(comparisons = my_comparisons)+
  scale_fill_manual(values=cols, name = "Treatments")+
  geom_sina(alpha=0.5)+
  theme_classic()+
  theme(legend.position = "none", plot.title = element_text(face = "bold", size = (15),hjust = 0.5)) +
  ggtitle("Hct")+
  xlab("")+
  ylab("% PCV")
#save("Hct", 13,10, plist_electro[["Hct"]])

all_electro_s <- subset(all_electro_T, all_electro_T$electro == "iCa")
ylim <- max(all_electro_s$value, na.rm = TRUE)
plist_electro[["iCa"]] <-all_electro_s %>%
  ggplot(aes(x=tt, y=value, fill=tt),na.rm = FALSE) +
  geom_violin(width=1, size=0.5, alpha = 0.8) +
  stat_compare_means(comparisons = my_comparisons)+
  scale_fill_manual(values=cols, name = "Treatments")+
  geom_sina(alpha=0.5)+
  theme_classic()+
  theme(legend.position = "none", plot.title = element_text(face = "bold", size = (15),hjust = 0.5)) +
  xlab("")+
  ggtitle("iCa")+
  ylab("mmol/L")
#save("iCa", 13,10, plist_electro[["iCa"]])

all_electro_s <- subset(all_electro_T, all_electro_T$electro == "Glu")
ylim <- max(all_electro_s$value, na.rm = TRUE)
plist_electro[["Glu"]] <-all_electro_s %>%
  ggplot(aes(x=tt, y=value, fill=tt),na.rm = FALSE) +
  geom_violin(width=1, size=0.5, alpha = 0.8) +
  stat_compare_means(comparisons = my_comparisons)+
  scale_fill_manual(values=cols, name = "Treatments")+
  geom_sina(alpha=0.5)+
  theme_classic()+
  theme(legend.position = "none", plot.title = element_text(face = "bold", size = (15),hjust = 0.5)) +
  xlab("")+
  ggtitle("Glu")+
  ylab("mmol/L")
#save("Glu", 13,10, plist_electro[["Glu"]])

all_electro_s <- subset(all_electro_T, all_electro_T$electro == "osmolality")
ylim <- max(all_electro_s$value, na.rm = TRUE)
plist_electro[["osmolality"]] <-all_electro_s %>%
  ggplot(aes(x=tt, y=value, fill=tt),na.rm = FALSE) +
  geom_violin(width=1, size=0.5, alpha = 0.8) +
  stat_compare_means(comparisons = my_comparisons)+
  scale_fill_manual(values=cols, name = "Treatments")+
  geom_sina(alpha=0.5)+
  theme_classic()+
  theme(legend.position = "none", plot.title = element_text(face = "bold", size = (15),hjust = 0.5)) +
  xlab("")+
  ggtitle("osmolality")+
  ylab("mmol/L")
#save("osmolality", 13,10, plist_electro[["osmolality"]])

all_electro_s <- subset(all_electro_T, all_electro_T$electro == "Hb")
ylim <- max(all_electro_s$value, na.rm = TRUE)
plist_electro[["Hb"]] <-all_electro_s %>%
  ggplot(aes(x=tt, y=value, fill=tt),na.rm = FALSE) +
  geom_violin(width=1, size=0.5, alpha = 0.8) +
  stat_compare_means(comparisons = my_comparisons)+
  scale_fill_manual(values=cols, name = "Treatments")+
  geom_sina(alpha=0.5)+
  theme_classic()+
  theme(legend.position = "none", plot.title = element_text(face = "bold", size = (15),hjust = 0.5)) +
  xlab("")+
  ggtitle("Hb")+
  ylab("mmol/L")
#save("Hb", 13,10, plist_electro[["Hb"]])

all_electro_s <- subset(all_electro_T, all_electro_T$electro == "Cl")
ylim <- max(all_electro_s$value, na.rm = TRUE)
plist_electro[["Cl"]] <-all_electro_s %>%
  ggplot(aes(x=tt, y=value, fill=tt),na.rm = FALSE) +
  geom_violin(width=1, size=0.5, alpha = 0.8) +
  stat_compare_means(comparisons = my_comparisons)+
  scale_fill_manual(values=cols, name = "Treatments")+
  geom_sina(alpha=0.5)+
  theme_classic()+
  theme(legend.position = "none", plot.title = element_text(face = "bold", size = (15),hjust = 0.5)) +
  xlab("")+
  ggtitle("Cl")+
  ylab("mmol/L")
#save("Cl", 13,10, plist_electro[["Cl"]])

all_electro_s <- subset(all_electro_T, all_electro_T$electro == "TCO2")
ylim <- max(all_electro_s$value, na.rm = TRUE)
plist_electro[["TCO2"]] <-all_electro_s %>%
  ggplot(aes(x=tt, y=value, fill=tt),na.rm = FALSE) +
  geom_violin(width=1, size=0.5, alpha = 0.8) +
  stat_compare_means(comparisons = my_comparisons)+
  scale_fill_manual(values=cols, name = "Treatments")+
  geom_sina(alpha=0.5)+
  theme_classic()+
  theme(legend.position = "none", plot.title = element_text(face = "bold", size = (15),hjust = 0.5)) +
  xlab("")+
  ggtitle("TCO2")+
  ylab("mmol/L")
#save("TCO2", 13,10, plist_electro[["TCO2"]])

all_electro_s <- subset(all_electro_T, all_electro_T$electro == "AnGap")
ylim <- max(all_electro_s$value, na.rm = TRUE)
plist_electro[["AnGap"]] <-all_electro_s %>%
  ggplot(aes(x=tt, y=value, fill=tt),na.rm = FALSE) +
  geom_violin(width=1, size=0.5, alpha = 0.8) +
  stat_compare_means(comparisons = my_comparisons)+
  scale_fill_manual(values=cols, name = "Treatments")+
  geom_sina(alpha=0.5)+
  theme_classic()+
  theme(legend.position = "none", plot.title = element_text(face = "bold", size = (15),hjust = 0.5)) +
  xlab("")+
  ggtitle("AnGap")+
  ylab("mmol/L")
#save("AnGap", 13,10, plist_electro[["AnGap"]])

#subset_thing_S <- all_electro_s %>% filter(sex == "F", H2O == "Standard")
#subset_thing_L <- all_electro_s %>% filter(sex == "F", H2O == "Low Fat")

#mean(subset_thing$value, na.rm = TRUE)
#sd(subset_thing$value, na.rm = TRUE)

#t.test(subset_thing_S$value, subset_thing_L$value)

electo_plots <- gridExtra::grid.arrange(grobs = plist_electro, nrow=3, ncol=4)
save("electo_plots", 40,30, electo_plots)
```
baseline <- interval(water_removal - days(3), water_removal)
cages26july$experiment_day[cages26july$DateTime %within% baseline == "TRUE"] <- "baseline"

dehydration females rep 1
```{r}
startdate =  as.Date("July-26-21", format = "%b-%d-%y")
weight_ID("26-July-21")
cages26july <- bring_in_data("26July21.csv", "Female")

cages26july$DateTime <- as_datetime(cages26july$DateTime)

dates <- unique(cages26july$StartDate)
cages26july$day <- match(cages26july$StartDate, dates)

water_removal <- ymd_hms("2021-07-26 10:30:59")
day1 <- interval(water_removal, water_removal + days(1))
day2 <- interval(water_removal + days(1), water_removal + days(2))
day3 <- interval(water_removal + days(2), water_removal + days(3))

cages26july <- cages26july %>%
    add_column(experiment_day = NA)

cages26july$experiment_day[cages26july$DateTime %within% day1 == "TRUE"] <- "day 1 no water"
cages26july$experiment_day[cages26july$DateTime %within% day2 == "TRUE"] <- "day 2 no water"
cages26july$experiment_day[cages26july$DateTime %within% day3 == "TRUE"] <- "day 3 no water"


ggplot(cages26july, aes(as.POSIXct(with(cages26july, StartDate + hms(StartTime))),y=Deg_C))+
  scale_x_datetime(date_breaks = "2 hours", date_labels = "%H:%M")+
  geom_line()
unique(cages26july$Animal_ID)
```

dehydration females rep 2
```{r}
startdate =  as.Date("Aug-3-21", format = "%b-%d-%y")
weight_ID("3-Aug-21")
cages03Aug <- bring_in_data("03Aug21.csv", "Female")

cages03Aug$DateTime <- as_datetime(cages03Aug$DateTime)

dates <- unique(cages03Aug$StartDate)
cages03Aug$day <- match(cages03Aug$StartDate, dates)

water_removal <- ymd_hms("2021-08-03 10:30:59")
day1 <- interval(water_removal, water_removal + days(1))
day2 <- interval(water_removal + days(1), water_removal + days(2))
day3 <- interval(water_removal + days(2), water_removal + days(3))

cages03Aug <- cages03Aug %>%
    add_column(experiment_day = NA)

cages03Aug$experiment_day[cages03Aug$DateTime %within% day1 == "TRUE"] <- "day 1 no water"
cages03Aug$experiment_day[cages03Aug$DateTime %within% day2 == "TRUE"] <- "day 2 no water"
cages03Aug$experiment_day[cages03Aug$DateTime %within% day3 == "TRUE"] <- "day 3 no water"

ggplot(cages03Aug, aes(as.POSIXct(with(cages03Aug, StartDate + hms(StartTime))),y=Deg_C))+
  scale_x_datetime(date_breaks = "2 hours", date_labels = "%H:%M")+
  geom_line()
unique(cages03Aug$Animal_ID)
```

dehydration females rep 3
```{r}
startdate =  as.Date("Aug-9-21", format = "%b-%d-%y")
weight_ID("9-Aug-21")
cages09Aug <- bring_in_data("09Aug21.csv", "Female")

cages09Aug$DateTime <- as_datetime(cages09Aug$DateTime)

dates <- unique(cages09Aug$StartDate)
cages09Aug$day <- match(cages09Aug$StartDate, dates)

water_removal <- ymd_hms("2021-08-09 10:30:59")
day1 <- interval(water_removal, water_removal + days(1))
day2 <- interval(water_removal + days(1), water_removal + days(2))
day3 <- interval(water_removal + days(2), water_removal + days(3))

cages09Aug <- cages09Aug %>%
    add_column(experiment_day = NA)

cages09Aug$experiment_day[cages09Aug$DateTime %within% day1 == "TRUE"] <- "day 1 no water"
cages09Aug$experiment_day[cages09Aug$DateTime %within% day2 == "TRUE"] <- "day 2 no water"
cages09Aug$experiment_day[cages09Aug$DateTime %within% day3 == "TRUE"] <- "day 3 no water"

ggplot(cages09Aug, aes(as.POSIXct(with(cages09Aug, StartDate + hms(StartTime))),y=Deg_C))+
  scale_x_datetime(date_breaks = "2 hours", date_labels = "%H:%M")+
  geom_point()
unique(cages09Aug$Animal_ID)
```

```{r}
startdate =  as.Date("Sep-13-21", format = "%b-%d-%y")
weight_ID("13-Sep-21")
cages13Sep <- bring_in_data("13Sep21.csv", "Male")

cages13Sep$DateTime <- as_datetime(cages13Sep$DateTime)

dates <- unique(cages13Sep$StartDate)
cages13Sep$day <- match(cages13Sep$StartDate, dates)

water_removal <- ymd_hms("2021-09-13 10:30:59")
day1 <- interval(water_removal, water_removal + days(1))
day2 <- interval(water_removal + days(1), water_removal + days(2))
day3 <- interval(water_removal + days(2), water_removal + days(3))

cages13Sep <- cages13Sep %>%
    add_column(experiment_day = NA)

cages13Sep$experiment_day[cages13Sep$DateTime %within% day1 == "TRUE"] <- "day 1 no water"
cages13Sep$experiment_day[cages13Sep$DateTime %within% day2 == "TRUE"] <- "day 2 no water"
cages13Sep$experiment_day[cages13Sep$DateTime %within% day3 == "TRUE"] <- "day 3 no water"

ggplot(cages13Sep, aes(as.POSIXct(with(cages13Sep, StartDate + hms(StartTime))),y=Deg_C))+
  scale_x_datetime(date_breaks = "2 hours", date_labels = "%H:%M")+
  geom_point()
unique(cages13Sep$Animal_ID)
```

```{r}
startdate =  as.Date("Sep-20-21", format = "%b-%d-%y")
weight_ID("20-Sep-21")
cages20Sep <- bring_in_data("20Sep21.csv", "Male")

cages20Sep$DateTime <- as_datetime(cages20Sep$DateTime)

dates <- unique(cages20Sep$StartDate)
cages20Sep$day <- match(cages20Sep$StartDate, dates)

water_removal <- ymd_hms("2021-09-20 10:30:59")
day1 <- interval(water_removal, water_removal + days(1))
day2 <- interval(water_removal + days(1), water_removal + days(2))
day3 <- interval(water_removal + days(2), water_removal + days(3))

cages20Sep <- cages20Sep %>%
    add_column(experiment_day = NA)

cages20Sep$experiment_day[cages20Sep$DateTime %within% day1 == "TRUE"] <- "day 1 no water"
cages20Sep$experiment_day[cages20Sep$DateTime %within% day2 == "TRUE"] <- "day 2 no water"
cages20Sep$experiment_day[cages20Sep$DateTime %within% day3 == "TRUE"] <- "day 3 no water"

ggplot(cages20Sep, aes(as.POSIXct(with(cages20Sep, StartDate + hms(StartTime))),y=Deg_C))+
  scale_x_datetime(date_breaks = "2 hours", date_labels = "%H:%M")+
  geom_point()
unique(cages20Sep$Animal_ID)
```

```{r}
startdate =  as.Date("Sep-27-21", format = "%b-%d-%y")
weight_ID("27-Sep-21")
cages27Sep <- bring_in_data("27Sep21.csv", "Male")

cages27Sep$DateTime <- as_datetime(cages27Sep$DateTime)

dates <- unique(cages27Sep$StartDate)
cages27Sep$day <- match(cages27Sep$StartDate, dates)

water_removal <- ymd_hms("2021-09-27 10:30:59")
day1 <- interval(water_removal, water_removal + days(1))
day2 <- interval(water_removal + days(1), water_removal + days(2))
day3 <- interval(water_removal + days(2), water_removal + days(3))

cages27Sep <- cages27Sep %>%
    add_column(experiment_day = NA)

cages27Sep$experiment_day[cages27Sep$DateTime %within% day1 == "TRUE"] <- "day 1 no water"
cages27Sep$experiment_day[cages27Sep$DateTime %within% day2 == "TRUE"] <- "day 2 no water"
cages27Sep$experiment_day[cages27Sep$DateTime %within% day3 == "TRUE"] <- "day 3 no water"

ggplot(cages27Sep, aes(as.POSIXct(with(cages27Sep, StartDate + hms(StartTime))),y=Deg_C))+
  scale_x_datetime(date_breaks = "2 hours", date_labels = "%H:%M")+
  geom_point()
unique(cages27Sep$Animal_ID)
```

all data
```{r}
females_dehy <- rbind(cages26july,cages03Aug,cages09Aug)
males_dehy <- rbind(cages13Sep,cages20Sep, cages27Sep)

unique(females_dehy$Animal_ID)
unique(males_dehy$Animal_ID)

unique(females_dehy$animal)
females_dehy <- females_dehy %>%
  mutate(H2O = case_when(
    animal== "0" ~ "yes",
    animal== "1" ~ "yes",
    animal== "2" ~ "yes",
    animal== "3" ~ "no",
    animal== "4" ~ "no",
    animal== "5" ~ "no",
    ))

unique(males_dehy$animal)
males_dehy <- males_dehy %>%
  mutate(H2O = case_when(
    animal== "0" ~ "yes",
    animal== "1" ~ "yes",
    animal== "2" ~ "yes",
    animal== "3" ~ "no",
    animal== "4" ~ "no",
    animal== "5" ~ "no",
    ))
```


Establish day and night
```{r}
females_dehy$time_in_S <- period_to_seconds(hms(females_dehy$StartTime)) #Total seconds to reach that point in the day
males_dehy$time_in_S <- period_to_seconds(hms(males_dehy$StartTime)) #Total seconds to reach that point in the day

#Establish when each interval/transition starts and stops
#Daytime interval: hrs:8:00-21:00
daytime_interval <- period_to_seconds(hms("09:00:00")):period_to_seconds(hms("20:00:00"))
#Night time: hrs 22:00-5:00 
nighttime_interval <- c((period_to_seconds(hms("21:00:01")):period_to_seconds(hms("24:59:59"))), #evening portion of 'nighttime'
                        (period_to_seconds(hms("00:00:00")):period_to_seconds(hms("06:00:00")))) #morning portion of 'nightitme'
#Morning transition (t1): 6:00-9:00
t1_interval <- period_to_seconds(hms("06:00:00")):period_to_seconds(hms("09:00:00"))
#Evening transition (t2): 20-21:00
t2_interval <- period_to_seconds(hms("20:00:00")):period_to_seconds(hms("21:00:00"))

#### Create data subsets for males and females for each H2O (day, night, baseline [BL]) and each time block [e.g., t1/transition1, daytime, t2/transistion2, nighttime])
# all males and females across all 3 H2Os (BL, hot, cold)
all_M = males_dehy[males_dehy$Sex == 'Male', ]
all_F = females_dehy[females_dehy$Sex == 'Female', ]

females_dehy_day = all_F[all_F$time_in_S %in% daytime_interval, ]
females_dehy_day$interval <- "light"
 
females_dehy_night = all_F[all_F$time_in_S %in% nighttime_interval, ]
females_dehy_night$interval <- "dark"

females_dehy_t1 = all_F[all_F$time_in_S %in% t1_interval, ]
females_dehy_t1$interval <- "T1"

females_dehy_t2 = all_F[all_F$time_in_S %in% t2_interval, ]
females_dehy_t2$interval <- "T2"

males_dehy_day = all_M[all_M$time_in_S %in% daytime_interval, ]
males_dehy_day$interval <- "light"
  
males_dehy_night = all_M[all_M$time_in_S %in% nighttime_interval, ]
males_dehy_night$interval <- "dark"

males_dehy_t1 = all_M[all_M$time_in_S %in% t1_interval, ]
males_dehy_t1$interval <- "T1"

males_dehy_t2 = all_M[all_M$time_in_S %in% t2_interval, ]
males_dehy_t2$interval <- "T2"

all_F <- rbind(females_dehy_day,females_dehy_night,females_dehy_t1,females_dehy_t2)

all_M <- rbind(males_dehy_day,males_dehy_night,males_dehy_t1,males_dehy_t2)
```

# IDENTIFY AND REMOVE OUTLIERS
### MALES ###
```{r}
count = 1
dependent_variables = c("EE_kJH", "RQ", "VO2", "VCO2", "H2Omg")
varname_list = c("EE_OLs","RQ_OLs","VO2_OLs","VCO2_OLs","H2O_OLs")

for (DV in dependent_variables){
  print(DV)
    model <- lm(as.formula(paste0(DV, " ~ Animal_ID + H2O")), data = all_M)
  model.metrics <- augment(model) %>% select(-.hat, -.sigma, -.fitted)
  summ <- model.metrics %>% filter(abs(.std.resid) > 3) %>% as.data.frame()

    OL_list = c()
  masterlist = c()
  for (each_outlier_row in 1:nrow(summ)){
    this_weight <- summ[each_outlier_row, "Animal_ID"]
    this_DV  <- summ[each_outlier_row, DV]
    OL_list <- c(OL_list, (which(all_M$Animal_ID == this_weight & all_M[DV] == this_DV)))

  }
  print(OL_list)
  #Assign list of outliers to specified variable lists (OL_list_EE, RQ, VO2, VCO2, mgH2O)
  assign(paste("OL_list_", DV, sep = ""), OL_list)  
}

masterlist <- c(OL_list_EE_kJH, OL_list_RQ, OL_list_VO2, OL_list_VCO2, OL_list_H2Omg)
masterlist_noDup <- unique(masterlist)

all_noOL_M <- all_M[-c(masterlist_noDup),]
#write.csv(all_noOL_M, "all_noOL_M.csv", row.names = FALSE)
```

# IDENTIFY AND REMOVE OUTLIERS
#### FEMALES ####
will need to change all Animal_ID back to weight once I have it in the dataset 
```{r}
count = 1
dependent_variables = c("EE_kJH", "RQ", "VO2", "VCO2", "H2Omg")
varname_list = c("EE_OLs","RQ_OLs","VO2_OLs","VCO2_OLs","H2O_OLs")

for (DV in dependent_variables){
  print(DV)
  model <- lm(as.formula(paste0(DV, " ~ Animal_ID + H2O")), data = all_F)
  model.metrics <- augment(model) %>% select(-.hat, -.sigma, -.fitted)
  summ <- model.metrics %>% filter(abs(.std.resid) > 3) %>% as.data.frame()
  OL_list = c()
  masterlist = c()
  for (each_outlier_row in 1:nrow(summ)){
    this_weight <- summ[each_outlier_row, "Animal_ID"]
    this_DV  <- summ[each_outlier_row, DV]
    OL_list <- c(OL_list, (which(all_F$Animal_ID == this_weight & all_F[DV] == this_DV)))
    
  }
  print(OL_list)
  assign(paste("OL_list_", DV, sep = ""), OL_list)  
}

masterlist <- c(OL_list_EE_kJH, OL_list_RQ, OL_list_VO2, OL_list_VCO2, OL_list_H2Omg)
masterlist_noDup <- unique(masterlist)
all_noOL_F <- all_F[-c(masterlist_noDup),]
#write.csv(all_noOL_F, "all_noOL_F.csv", row.names=FALSE)



all_noOL <- rbind(all_noOL_F, all_noOL_M)
#remove empty cage 
target <- c(0,1,2,3,4,5,6)
all_noOL <- all_noOL %>% filter(animal %in% target)


weight <- all_noOL %>% mutate(weight = coalesce(weight_0, weight_1, weight_2, weight_3)) %>% select(weight)
all_noOL["weight"] <- weight
body_temp<- all_noOL %>% mutate(body_temp = coalesce(body_temp0, body_temp1, body_temp2, body_temp3)) %>% select(body_temp)
all_noOL["body_temp"] <- body_temp
all_noOL = select(all_noOL, -weight_0, -weight_1, -weight_2, -weight_3, -body_temp0, -body_temp1, -body_temp2, -body_temp3)

all_noOL$experiment_day[all_noOL$H2O == 'yes'] <- "yes water"

#note: H2Omg is mg h20 min-1
#H2Og is g h2o h -1

all_noOL$H2Og <- all_noOL$H2Omg * 0.06

write.csv(all_noOL, "cages.csv", row.names=FALSE)
```

ANCOVA
```{r}
all_noOL$day <- as.factor(all_noOL$day)
cols2 <- c("Baseline"="#0C62AF","1"="#CD622E","2"="#CD422E", "3"="#822B0F", "4"="#5C0001")

all_noOL <- na.omit(all_noOL)

water <- ggplot(data = all_noOL %>% filter(H2O == "yes"), aes(x=as.POSIXct(StartTime),y=H2Og))+
  scale_x_datetime(date_breaks = "3 hours", date_labels = "%H:%M")+
  annotate("rect", xmin = as.POSIXct("1970-01-01 00:00:01", tz="UTC"), 
           xmax = as.POSIXct("1970-01-01 06:00:00", tz="UTC"), 
           ymin = -Inf, ymax = Inf, fill="grey84") +
  annotate("rect", xmin = as.POSIXct("1970-01-01 21:00:00", tz="UTC"), 
           xmax = as.POSIXct("1970-01-01 23:59:59", tz="UTC"), 
           ymin = -Inf, ymax = Inf, fill="grey84") +
  geom_point(all_noOL %>% filter(H2O == "yes"), mapping = aes(color="Baseline"), alpha=.3, size=1)+
  geom_point(all_noOL %>% filter(H2O == "no", day == 1), mapping = aes(color="1"), alpha=.3, size=1)+
  geom_point(all_noOL %>% filter(H2O == "no", day == 2), mapping = aes(color="2"), alpha=.3, size=1)+
  geom_point(all_noOL %>% filter(H2O == "no", day == 3), mapping = aes(color="3"), alpha=.3, size=1)+
  geom_point(all_noOL %>% filter(H2O == "no", day == 4), mapping = aes(color="4"), alpha=.3, size=1)+
  geom_smooth(method='gam',se = FALSE, all_noOL %>% filter(H2O == "yes"), mapping = aes(color="Baseline"))+
  geom_smooth(method='gam',se = FALSE, all_noOL %>% filter(H2O == "no", day == 1), mapping = aes(color="1"))+
  geom_smooth(method='gam',se = FALSE, all_noOL %>% filter(H2O == "no", day == 2), mapping = aes(color="2"))+
  geom_smooth(method='gam',se = FALSE, all_noOL %>% filter(H2O == "no", day == 3), mapping = aes(color="3"))+
  geom_smooth(method='gam',se = FALSE, all_noOL %>% filter(H2O == "no", day == 4), mapping = aes(color="4"))+
  labs(x = "", y = bquote("RWL g h"^-1))+
  guides(alpha = "none")+
  facet_wrap(~Sex)+
  theme_minimal()+
  scale_colour_manual(name="experiment day",values=cols2)

water
save("water1",25, 10, water)

EE <- ggplot(data = all_noOL %>% filter(H2O == "yes"), aes(x=as.POSIXct(StartTime),y=EE_kJH))+
  scale_x_datetime(date_breaks = "3 hours", date_labels = "%H:%M")+
  annotate("rect", xmin = as.POSIXct("1970-01-01 00:00:01", tz="UTC"), 
           xmax = as.POSIXct("1970-01-01 06:00:00", tz="UTC"), 
           ymin = -Inf, ymax = Inf, fill="grey84") +
  annotate("rect", xmin = as.POSIXct("1970-01-01 21:00:00", tz="UTC"), 
           xmax = as.POSIXct("1970-01-01 23:59:59", tz="UTC"), 
           ymin = -Inf, ymax = Inf, fill="grey84") +
    geom_point(all_noOL %>% filter(H2O == "yes"), mapping = aes(color="Baseline"), alpha=.3, size=1)+
  geom_point(all_noOL %>% filter(H2O == "no", day == 1), mapping = aes(color="1"), alpha=.3, size=1)+
  geom_point(all_noOL %>% filter(H2O == "no", day == 2), mapping = aes(color="2"), alpha=.3, size=1)+
  geom_point(all_noOL %>% filter(H2O == "no", day == 3), mapping = aes(color="3"), alpha=.3, size=1)+
  geom_point(all_noOL %>% filter(H2O == "no", day == 4), mapping = aes(color="4"), alpha=.3, size=1)+
  geom_smooth(method='gam',se = FALSE, all_noOL %>% filter(H2O == "yes"), mapping = aes(color="Baseline"))+
  geom_smooth(method='gam',se = FALSE, all_noOL %>% filter(H2O == "no", day == 1), mapping = aes(color="1"))+
  geom_smooth(method='gam',se = FALSE, all_noOL %>% filter(H2O == "no", day == 2), mapping = aes(color="2"))+
  geom_smooth(method='gam',se = FALSE, all_noOL %>% filter(H2O == "no", day == 3), mapping = aes(color="3"))+
  geom_smooth(method='gam',se = FALSE, all_noOL %>% filter(H2O == "no", day == 4), mapping = aes(color="4"))+
  guides(alpha = "none")+
  scale_colour_manual(name="experiment day",values=cols2)+
  labs(y = bquote("EE kJ h"^-1), x = "")+
  theme_minimal()+
  facet_wrap(~Sex)

RQ <- ggplot(data = all_noOL %>% filter(H2O == "yes"), aes(x=as.POSIXct(StartTime),y=RQ))+
  scale_x_datetime(date_breaks = "3 hours", date_labels = "%H:%M")+
  annotate("rect", xmin = as.POSIXct("1970-01-01 00:00:01", tz="UTC"), 
           xmax = as.POSIXct("1970-01-01 06:00:00", tz="UTC"), 
           ymin = -Inf, ymax = Inf, fill="grey84") +
  annotate("rect", xmin = as.POSIXct("1970-01-01 21:00:00", tz="UTC"), 
           xmax = as.POSIXct("1970-01-01 23:59:59", tz="UTC"), 
           ymin = -Inf, ymax = Inf, fill="grey84") +
    geom_point(all_noOL %>% filter(H2O == "yes"), mapping = aes(color="Baseline"), alpha=.3, size=1)+
  geom_point(all_noOL %>% filter(H2O == "no", day == 1), mapping = aes(color="1"), alpha=.3, size=1)+
  geom_point(all_noOL %>% filter(H2O == "no", day == 2), mapping = aes(color="2"), alpha=.3, size=1)+
  geom_point(all_noOL %>% filter(H2O == "no", day == 3), mapping = aes(color="3"), alpha=.3, size=1)+
  geom_point(all_noOL %>% filter(H2O == "no", day == 4), mapping = aes(color="4"), alpha=.3, size=1)+
  geom_smooth(method='gam',se = FALSE, all_noOL %>% filter(H2O == "yes"), mapping = aes(color="Baseline"))+
  geom_smooth(method='gam',se = FALSE, all_noOL %>% filter(H2O == "no", day == 1), mapping = aes(color="1"))+
  geom_smooth(method='gam',se = FALSE, all_noOL %>% filter(H2O == "no", day == 2), mapping = aes(color="2"))+
  geom_smooth(method='gam',se = FALSE, all_noOL %>% filter(H2O == "no", day == 3), mapping = aes(color="3"))+
  geom_smooth(method='gam',se = FALSE, all_noOL %>% filter(H2O == "no", day == 4), mapping = aes(color="4"))+
  theme_minimal()+
  labs(y = bquote("RQ"), x = "hour")+
  scale_colour_manual(name="experiment day",values=cols2)+ 
  ylim(0.5, 1.5)+
  facet_wrap(~Sex)

water/EE/RQ
save("multi",30, 30, water/EE/RQ)
save("water",25, 10, water)
```

```{r}
all_noOL$day <- as.factor(all_noOL$day)
all_noOL$Animal_ID <- as.factor(all_noOL$Animal_ID)
electrolyte_data$Animal_ID <- electrolyte_data$mouse_ID

subset_all_noOL <- all_noOL[,c("Sex","Animal_ID", "H2O")]

split_data <- data.frame(do.call('rbind', strsplit(as.character(all_noOL$StartTime),':',fixed=TRUE)))

all_noOL$day_time <- hours(split_data$X1)+minutes(split_data$X2)+seconds(split_data$X3)
all_noOL$hour <- round(all_noOL$time_in_S/3600, digits=0)

stuff <- all_noOL %>% group_by(day,hour, Animal_ID) %>% summarise(H2Og = mean(H2Og))
sum_H2Og<- setNames(aggregate(stuff$H2Og, list(stuff$Animal_ID), FUN=sum),c("Animal_ID", "total_H2Og"))

sum_H2Og<- distinct(merge(sum_H2Og, subset_all_noOL, by = "Animal_ID"))
ancova_data<- distinct(merge(sum_H2Og, electrolyte_data, by = c("Animal_ID")))


stuff2 <- all_noOL %>% group_by(day,hour, Animal_ID) %>% summarise(EE_kJH = mean(EE_kJH))
sum_EE_kJH<- setNames(aggregate(stuff2$EE_kJH, list(stuff2$Animal_ID), FUN=sum),c("Animal_ID", "total_EE_kJH"))

sum_EE_kJH<- distinct(merge(sum_EE_kJH, subset_all_noOL, by = "Animal_ID"))
ancova_data<- distinct(merge(sum_EE_kJH, electrolyte_data, by = c("Animal_ID")))

ancova_data$norm_delta <- ancova_data$total_weight_delta / ancova_data$weight0

mod1 = lm(weight0 ~ total_H2Og, data = ancova_data)
summary(mod1) 
plot(ancova_data$total_H2Og,ancova_data$weight0,col = "blue", abline(lm(ancova_data$total_H2Og~ancova_data$weight0)),cex = 1.3,pch = 16)

mod2 = lm(weight0 ~ total_weight_delta, data = ancova_data)
summary(mod2) 
plot(ancova_data$total_weight_delta,ancova_data$weight0,col = "blue", abline(lm(ancova_data$total_weight_delta~ancova_data$weight0)),cex = 1.3,pch = 16)

mod3 = lm(weight0 ~ norm_delta, data = ancova_data)
summary(mod3) 
plot(ancova_data$norm_delta,ancova_data$weight0,col = "blue", abline(lm(ancova_data$norm_delta~ancova_data$weight0)),cex = 1.3,pch = 16)

mod4 = lm(weight0 ~ total_EE_kJH, data = ancova_data)
summary(mod4) 
plot(ancova_data$total_EE_kJH,ancova_data$weight0,col = "blue", abline(lm(ancova_data$total_EE_kJH~ancova_data$weight0)),cex = 1.3,pch = 16)
```

```{r}
# 2.  Perform ANOVA with X as Response
anovaX_mod<-lm(weight0 ~ H2O.x*Sex, ancova_data)
anova(anovaX_mod)

# 3.  Perform ANOVA with total_H2Og as Response
anovatotal_H2Og_mod<-lm(total_H2Og ~ H2O.x*Sex, ancova_data)
anova(anovatotal_H2Og_mod)

# 4.  Test for homogeneity of slopes
slopes_mod<-lm(total_H2Og ~ H2O.x*Sex + weight0 + H2O.x:weight0, ancova_data)
anova(slopes_mod)

# 5.  The ANCOVA
library(car)
ancova_mod<-lm(total_H2Og ~ H2O.x*Sex + weight0, ancova_data)
Anova(ancova_mod, type = 2)

# 6.  Find beta and Xmean; then create Z
summary(ancova_mod)
mean_val <- mean(ancova_data$weight, na.rm=TRUE)
ancova_data$Z<-ancova_data$H2Og + 0.002604*(ancova_data$weight - mean_val)

library(emmeans)
# INTERLUDE:  Comparing means and analyses
#library(emmeans)
lima_lsm <- emmeans(ancova_mod, "tt")
adj_means <- aggregate(ancova_data$Z, list(ancova_data$tt), mean)

anovaZ_mod<-lm(Z ~ tt*Sex, ancova_data)
anova(anovaZ_mod)

# 7.  Normality of residuals
anovaZ_mod<-lm(Z ~ H2O*Sex*day, ancova_data)
ancova_data$anovaZ_resids <- residuals(anovaZ_mod)
shapiro.test(ancova_data$anovaZ_resids)

# 8.  Homogeneity of variances
#library(car)
leveneTest(Z ~ H2O, data = ancova_data)

# 9.  Additivity of main effects
ancova_data$anovaZ_preds <- predict(anovaZ_mod)
ancova_data$sq_anovaZ_preds <- ancova_data$anovaZ_preds^2
tuketotal_H2OgZ_mod<-lm(Z ~ tt + Sex + sq_anovaZ_preds, ancova_data)
anova(tuketotal_H2OgZ_mod)

# 10.  The ANCOVA, with desired subsequent analysis
ancova_mod<-lm(H2Og ~ tt*Sex + weight, ancova_data)
Anova(ancova_mod, ttotal_H2Ogpe = 2)

#Tukey separation of adjusted Sex means
lima_lsm <- emmeans(ancova_mod, c("Sex","tt"))
contrast(lima_lsm, method = "pairwise", adjust = "tukey")

emmip(ancova_mod, Sex~tt, CIs=TRUE)
emmip(ancova_mod, tt~Sex, CIs=TRUE)

```

```{r}
RQ <- ggplot(data = all_noOL,aes(color = tt, x=as.numeric(day_time),y=RQ))+
  annotate("rect", xmin = 76032, xmax = 107474, ymin = -Inf, ymax = Inf, fill="grey84") +
  annotate("rect", xmin = 162079, xmax = 194341, ymin = -Inf, ymax = Inf, fill="grey84") +
  annotate("rect", xmin = 249086, xmax = 280528, ymin = -Inf, ymax = Inf, fill="grey84") +
  scale_color_manual(values=cols, name = "Treatments") +
  geom_point(alpha = .5)+
  theme_classic()+
  #geom_smooth(method='loess', span=.1, level=0.99)+
  guides(alpha = FALSE)+
  #theme(axis.text.y=element_text(size=12))+
  scale_x_time()+
  geom_hline(yintercept = 0.8907387, color='black', size=0.5)+
  theme(axis.text.x=element_blank())+
  labs(x = "", y = "RQ")+
  facet_wrap(~Sex)+
  ylim(0.5, 1.5)


EE <- ggplot(data = all_noOL,aes(color = tt, x=as.numeric(day_time),y=EE_kJH))+
  annotate("rect", xmin = 76032, xmax = 107474, ymin = -Inf, ymax = Inf, fill="grey84") +
  annotate("rect", xmin = 162079, xmax = 194341, ymin = -Inf, ymax = Inf, fill="grey84") +
  annotate("rect", xmin = 249086, xmax = 280528, ymin = -Inf, ymax = Inf, fill="grey84") +
  scale_color_manual(values=cols, name = "Treatments") +
  geom_point(alpha = .5)+
  theme_classic()+
  #geom_smooth(method='loess', span=.1, level=0.99)+
  guides(alpha = FALSE)+
  #theme(axis.text.y=element_text(size=12))+
  scale_x_time(breaks = "6 hr")+
  facet_wrap(~Sex)+
  labs(x = "", y = "EE kJ h-1")


H2Omg_plot <- ggplot(data = test,aes(color = tt, x= per,y=H2Og))+
  annotate("rect", xmin = 28800, xmax = 75600, ymin = -Inf, ymax = Inf, fill="grey84") +
  annotate("rect", xmin = 115200, xmax = 162000, ymin = -Inf, ymax = Inf, fill="grey84") +
  annotate("rect", xmin = 201600, xmax = 248400, ymin = -Inf, ymax = Inf, fill="grey84") +
  scale_color_manual(values=cols, name = "Treatments") +
  geom_point(alpha = .5)+
  theme_classic()+
  #geom_smooth(method='loess', span=.1, level=0.99)+
  guides(alpha = FALSE)+
  theme(axis.text.y=element_text(size=12))+
  facet_wrap(~Sex)+
  scale_x_time() +
  labs(y = "RWL g h-1", x = "hour")

mean_EE <- ggline(all_noOL, x = "hour", y = "EE_kJH", add = "mean_se",color = "H2O", facet.by = "Sex")+
  stat_compare_means(aes(group = H2O), label = "p.signif",hide.ns = TRUE,label.y = 1)+
  scale_color_manual(values=c("firebrick","grey50")) +
  labs(y = "mean EE_kJH0")+
  scale_x_discrete(breaks=seq(0, 100, 5))

mean_water <- ggline(all_noOL, x = "hour", y = "H2Og", add = "mean_se",color = "H2O", facet.by = "Sex")+
  stat_compare_means(aes(group = H2O), label = "p.signif",hide.ns = TRUE,label.y = 5.8)+
  scale_color_manual(values=c("firebrick","grey50")) +
  labs(y = "mean H2Omg")+
  scale_x_discrete(breaks=seq(0, 100, 5))

mean_RQ <- ggline(all_noOL, x = "hour", y = "RQ", add = "mean_se",color = "H2O", facet.by = "Sex")+
  stat_compare_means(aes(group = H2O), label = "p.signif",hide.ns = TRUE,label.y = 1.28)+
  scale_color_manual(values=c("firebrick","grey50")) +
  geom_hline(yintercept = .8907387)+
  labs(y = "mean RQ")+
  scale_x_discrete(breaks=seq(0, 100, 5))
  
RQ/EE/H2Omg_plot

setwd("/Users/danielleblumstein/Documents/UNH/abstracts_proposals_writings/dehydration")
save("RQ",35, 10, RQ)
save("EE",35, 10, EE)
save("H2Omg_plot",35, 10, H2Omg_plot)

save("mean_EE", 35, 10, mean_EE)
save("mean_water", 35, 10, mean_water)
save("mean_RQ", 35, 10, mean_RQ)

dev.off()
```

```{r}
subset_thing <- all_noOL %>% filter(interval == "light", H2O == "no", Sex == "Male", day == 4) 
cat(min(subset_thing$RQ),"\n")
cat(max(subset_thing$RQ),"\n")
cat(mean(subset_thing$RQ),"+/-",sd(subset_thing$RQ))
```


######BODY TEMP
```{r}
devtools::install_github("kassambara/ggpubr")

cols <- c("yes"="#0C62AF","no"="#822B0F")

dehydration_data$water<-as.factor(dehydration_data$H2O)
dehydration_data$hour<-as.numeric(dehydration_data$hour)

for (a in unique(dehydration_data$sex)) {
  sexs <- subset(dehydration_data, sex == a)
  for (b in unique(dehydration_data$hour)) {
    hour <- subset(sexs, hour== b)
    for (c in unique(dehydration_data$H2O)) {
      print(c(a,b,c))
      d1 <-subset(hour, H2O == "no", body_temp)
      mean1 <- mean(d1$body_temp)
      
      d2 <-subset(hour, H2O == "yes", body_temp)
      mean2 <- mean(d2$body_temp)
      
      print(power.t.test(n = 9, delta = mean1-mean2, sd = sd(hour$body_temp), sig.level = 0.05, power = NULL, type = "two.sample", alternative = "two.sided"))
      print(var(subset(hour, H2O == c, body_temp)))
      print(mean(hour$body_temp))
    }
  }
}

summary(d1)
var(d1)

require(pwr)

pwr.anova.test(f=0.4,k=16,n=9,sig.level=0.05)

mean_delta_weight <- ggline(dehydration_data, x = "hour", y = "delta_weight", add = "mean_se",color = "water", facet.by = "sex")+
  stat_compare_means(aes(group = H2O), label = "p.signif",hide.ns = TRUE,label.y = .34)+
  scale_color_manual(values=cols, name = "Treatments") +
  labs(y = bquote("mean delta weight g day"^-1))

mean_weight <- ggline(dehydration_data, x = "hour", y = "weight", add = "mean_se",color = "water", facet.by = "sex")+
  stat_compare_means(aes(group = H2O), label = "p.signif",hide.ns = TRUE,label.y = 22.9)+
  scale_color_manual(values=cols, name = "Treatments") +
  labs(y = "mean weight g")

mean_weight/mean_delta_weight 

save("weight", 20, 20, mean_weight/mean_delta_weight)
```


```{r}
temp_test2 <- read.csv("~/Documents/UNH/metabolic chamber/dehydration/temp_test2.csv")
temp_test2 <- temp_test2 |>
    mutate(tt = fct_cross(water, sex))
all_combo<-unique(temp_test2$tt)

temp_test2$hour <- as.numeric(temp_test2$hour)
temp_test2$water <- as.factor(temp_test2$water)
temp_test2$temp <- as.numeric(temp_test2$temp)

body_temp2 <- ggline(temp_test2, x = "hour", y = "temp", add = "mean_se",color = "water", facet.by = c("time","sex"))+
  stat_compare_means(aes(group = water), label = "p.format",hide.ns = TRUE,label.y = 39)+
  scale_color_manual(values=cols, name = "Treatments") +
  expand_limits(y=c(NA, 40))+
  labs(y = "mean body temperature (deg C)")+
  facet_grid(time~sex, margins = "time") 
body_temp2

save("body_temp2", 20, 15, body_temp2)

```

```{r}
#remotes::install_github("mjskay/ggblend")
library(ggblend)

EE <- ggplot(data = all_noOL %>% filter(H2O == "yes"), aes(x=as.POSIXct(StartTime),y=EE_kJH))+
  scale_x_datetime(date_breaks = "2 hours", date_labels = "%H:%M")+
  annotate("rect", xmin = as.POSIXct("1970-01-01 00:00:01", tz="UTC"), 
           xmax = as.POSIXct("1970-01-01 06:00:00", tz="UTC"), 
           ymin = -Inf, ymax = Inf, fill="grey84") +
  annotate("rect", xmin = as.POSIXct("1970-01-01 21:00:00", tz="UTC"), 
           xmax = as.POSIXct("1970-01-01 23:59:59", tz="UTC"), 
           ymin = -Inf, ymax = Inf, fill="grey84") +
  geom_point(all_noOL %>% filter(H2O == "no", day == 1), mapping = aes(color="1", alpha=0.4))+
  geom_point(all_noOL %>% filter(H2O == "no", day == 2), mapping = aes(color="2", alpha=0.4))+
  geom_point(all_noOL %>% filter(H2O == "no", day == 3), mapping = aes(color="3", alpha=0.4))+
  geom_point(all_noOL %>% filter(H2O == "no", day == 4), mapping = aes(color="4", alpha=0.4))+
  geom_point(all_noOL %>% filter(H2O == "yes"), mapping = aes(color="Baseline", alpha=0.4)) +
  theme_classic()+
  ylim(0,2.5) +
  geom_smooth(all_noOL %>% filter(H2O == "no", day == 1), mapping = aes(color="1", alpha=0.4))+
  geom_smooth(all_noOL %>% filter(H2O == "no", day == 2), mapping = aes(color="2", alpha=0.4))+
  geom_smooth(all_noOL %>% filter(H2O == "no", day == 3), mapping = aes(color="3", alpha=0.4))+
  geom_smooth(all_noOL %>% filter(H2O == "no", day == 4), mapping = aes(color="4", alpha=0.4))+
  geom_smooth(all_noOL %>% filter(H2O == "yes"), mapping = aes(color="Baseline", alpha=0.4))+
  labs(x = "", y = "EE")+
  guides(alpha = "none")+
  facet_wrap(~Sex)+
  scale_colour_manual(name="Dehydration",values=cols2)

RQ <- ggplot(data = all_noOL %>% filter(H2O == "yes"), aes(x=as.POSIXct(StartTime),y=RQ))+
  scale_x_datetime(date_breaks = "2 hours", date_labels = "%H:%M")+
  annotate("rect", xmin = as.POSIXct("1970-01-01 00:00:01", tz="UTC"), 
           xmax = as.POSIXct("1970-01-01 06:00:00", tz="UTC"), 
           ymin = -Inf, ymax = Inf, fill="grey84") +
  annotate("rect", xmin = as.POSIXct("1970-01-01 21:00:00", tz="UTC"), 
           xmax = as.POSIXct("1970-01-01 23:59:59", tz="UTC"), 
           ymin = -Inf, ymax = Inf, fill="grey84") +
  geom_point(all_noOL %>% filter(H2O == "no", day == 1), mapping = aes(color="1", alpha=0.4))+
  geom_point(all_noOL %>% filter(H2O == "no", day == 2), mapping = aes(color="2", alpha=0.4))+
  geom_point(all_noOL %>% filter(H2O == "no", day == 3), mapping = aes(color="3", alpha=0.4))+
  geom_point(all_noOL %>% filter(H2O == "no", day == 4), mapping = aes(color="4", alpha=0.4))+
  geom_point(all_noOL %>% filter(H2O == "yes"), mapping = aes(color="Baseline", alpha=0.4))+
  theme_classic()+
  ylim(0,2) +
  geom_smooth(all_noOL %>% filter(H2O == "no", day == 1), mapping = aes(color="1", alpha=0.4))+
  geom_smooth(all_noOL %>% filter(H2O == "no", day == 2), mapping = aes(color="2", alpha=0.4))+
  geom_smooth(all_noOL %>% filter(H2O == "no", day == 3), mapping = aes(color="3", alpha=0.4))+
  geom_smooth(all_noOL %>% filter(H2O == "no", day == 4), mapping = aes(color="4", alpha=0.4))+
  geom_smooth(all_noOL %>% filter(H2O == "yes"), mapping = aes(color="Baseline", alpha=0.4))+
  labs(x = "", y = "RQ")+
  guides(alpha = "none")+
  facet_wrap(~Sex)+
  scale_colour_manual(name="Dehydration",values=cols2)

test = subset(all_noOL, all_noOL$day != 0 & all_noOL$time_in_S > 38373 )

all_noOL = all_noOL %>%  filter(!(day == 0 & time_in_S <= 38373))

water <- ggplot(data = test, aes(x=as.POSIXct(StartTime),y=H2Og, color = tt))+
  scale_x_datetime(date_breaks = "2 hours", date_labels = "%H:%M")+
  annotate("rect", xmin = as.POSIXct("1970-01-01 00:00:01", tz="UTC"), 
           xmax = as.POSIXct("1970-01-01 06:00:00", tz="UTC"), 
           ymin = -Inf, ymax = Inf, fill="grey84") +
  annotate("rect", xmin = as.POSIXct("1970-01-01 21:00:00", tz="UTC"), 
           xmax = as.POSIXct("1970-01-01 23:59:59", tz="UTC"), 
           ymin = -Inf, ymax = Inf, fill="grey84") +
  theme_classic()+
  geom_point(all_noOL %>% filter(H2O == "yes"), mapping = aes(color="yes", alpha=0.4))+
  geom_point(all_noOL %>% filter(H2O == "no", day == 0), mapping = aes(color="no:0", alpha=0.4))+
  geom_point(all_noOL %>% filter(H2O == "no", day == 1), mapping = aes(color="no:1", alpha=0.4))+
  geom_point(all_noOL %>% filter(H2O == "no", day == 2), mapping = aes(color="no:2", alpha=0.4))+
  geom_point(all_noOL %>% filter(H2O == "no", day == 3), mapping = aes(color="no:3", alpha=0.4))+
  geom_smooth(method = "gam",se = FALSE,all_noOL %>% filter(H2O == "yes"), mapping = aes(color="yes", alpha=0.4))+
  geom_smooth(method = "gam", se = FALSE,all_noOL %>% filter(H2O == "no", day == 0), mapping = aes(color="no:0", alpha=0.4))+
  geom_smooth(method = "gam", se = FALSE,all_noOL %>% filter(H2O == "no", day == 1), mapping = aes(color="no:1", alpha=0.4))+
  geom_smooth(method = "gam", se = FALSE,all_noOL %>% filter(H2O == "no", day == 2), mapping = aes(color="no:2", alpha=0.4))+
  geom_smooth(method = "gam", se = FALSE, all_noOL %>% filter(H2O == "no", day == 3), mapping = aes(color="no:3", alpha=0.4))+
  labs(x = "", y = "TWL")+
  guides(alpha = "none")+
  facet_wrap(~Sex) +
  scale_colour_manual(name="water status",values=cols2)
water

EE/water/RQ
save("multi",35, 35, EE/water/RQ)

head(all_noOL$StartTime)

all_combo
```

data needed for gamm analysis
```{r}
library(mgcv)
library(timeDate)
library(gratia)

dd <- as.data.frame(all_noOL)

index <- c(1,8)

for (i in index) dd[,i] <- as.factor(dd[,i])
summary(dd)
#   dd[1:20,] ; tail(dd)

## make continuous time variable
library(timeDate)
dd$doy <- dayOfYear(as.timeDate(dd$StartDate))
dd$ctime <- dd$doy + dd$time_in_S / (24*60*60)

## make time in day (values between 0 and 1) ; scale may be better for gam
dd$time_in_D <- dd$time_in_S /(24 * 60 * 60)
summary(dd$time_in_D)

# make Animal_ID a factor:
dd$ID <- as.factor(dd$Animal_ID)
dd$startexp <- 0  # initializing

ind <- levels(dd$ID)
for (i in 1:length(ind) ){  # i = 1
  startEXP <- min(dd$doy[dd$ID == ind[i] ],na.rm=T)
  dd$startexp[dd$ID == ind[i] ] <- startEXP
}
table(dd$startexp)

dd$startexp <- as.factor(dd$startexp)
levs <- levels(dd$startexp)

# create "time in experiment"  in units of day
dd$time_in_D <- as.numeric(dd$StartTime)

write.csv(dd, "dd.csv", row.names = FALSE)
```


```{r}
dd$H2O <- as.factor(dd$H2O)
dd$days <- as.numeric(dd$day_time)
dd$day <- as.factor(dd$day)

dd <- dd |>
    mutate(tt = fct_cross(H2O, day))
all_combo<-unique(dd$tt)
```

```{r}
M2_v1 <- bam(H2Og ~ H2O * Sex + day + s(time_in_D,by=tt, bs="cr",k=70), data = dd, random = list(startexp = ~1, Animal_ID = ~1|startexp), method="REML")

M2_v2 <- bam(H2Og ~ H2O * Sex + s(day, day_time, by=tt,k=70), data = dd, random = list(startexp = ~1, Animal_ID = ~1|startexp), method="REML")

AIC(M2_v1, M2_v2)

#if the data is big change to bs = 'cr'
#to determine if K has been set too low.
gam.check(M2_v1)

summary(M2_v1)  

draw(M2_v2)
plot(M2_v2, page = 1, scheme = 2, shade =T)
plot(M2_v2, scheme = 2)
vis.gam(M2_v2, view = c("day", "days"),theta = 50, n.grid = 50, lwd = 0.4)

#yellow = larger predictions
#red = smaller predictions
    
vis.gam(M2_v2, theta = 120, n.grid = 50, lwd = 0.4)

ds1 <- data_slice(M2, time_in_D = evenly(time_in_D, n = 86400),
    H2O = level(H2O, "no"), Sex = level(Sex, "Female"),tt = level(tt, "no:Female"))

fv1 <- fitted_values(M2, data = ds1, scale = "response")

fv1 |>
    ggplot(aes(x = days, y = fitted)) +
    geom_point(data = dd |>
                 filter(Sex == "Female", H2O == "no"),
        mapping = aes(y = H2Omg),
        alpha = 0.8, colour = "steelblue") +
    geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2) +
    geom_line() +
    labs(title = expression(Estimated ~ CO[2] ~ H2Omg),
        subtitle = "females without water")

#female
ds2 <- data_slice(M2, days = evenly(days, n = 100),
    H2O = evenly(H2O), Sex = level(Sex, "Female")) |>
    mutate(tt = fct_cross(H2O, Sex, keep_empty = TRUE))

fitted_values(M2, data = ds2, scale = "response")|>
    ggplot(aes(x = days, y = fitted, group = H2O)) +
    geom_point(data = dd |> filter(Sex == "Female"),
        mapping = aes(y = H2Omg, colour = H2O),
        alpha = 0.8) +
    geom_ribbon(aes(ymin = lower, ymax = upper, fill = H2O),
        alpha = 0.2) +
    geom_line(aes(colour = H2O))+
  labs(subtitle = "females")

#male
ds2 <- data_slice(M2, days = evenly(days, n = 100),
    H2O = evenly(H2O), Sex = level(Sex, "Male")) |>
    mutate(tt = fct_cross(H2O, Sex, keep_empty = TRUE))

fitted_values(M2, data = ds2, scale = "response")|>
    ggplot(aes(x = days, y = fitted, group = H2O)) +
    geom_point(data = dd |> filter(Sex == "Male"),
        mapping = aes(y = H2Omg, colour = H2O),
        alpha = 0.8) +
    geom_ribbon(aes(ymin = lower, ymax = upper, fill = H2O),
        alpha = 0.2) +
    geom_line(aes(colour = H2O))+
    labs(subtitle = "males")

#all the curves :)
###############################

ds4 <- data_slice(M2_v1, time_in_D = evenly(time_in_D, n = 100),
                  tt = c("yes:1", "yes:2", "yes:3", "yes:4", "no:1",  "no:2",  "no:3",  "no:4" ))

#cols <- c("1"="#1E837E","2"="#C7730B","3"="#AF5548", "4"="#6F4242", "Baseline" = "#80858E")

#cols <- c("yes:Male"="#59859F","no:Male"="#9D5933","yes:Female"="#386251", "no:Female"="#6F4242")

dd$fz <- as.factor(dd$tt)

RWL_gam <- fitted_values(M2_v1, data = ds4) |>
  mutate(fz = factor(tt)) |>
  ggplot(aes(x = days, y = fitted, colour = fz, group = fz)) +
  annotate("rect", xmin = 76032, xmax = 107474, ymin = -Inf, ymax = Inf, fill="grey84") +
  annotate("rect", xmin = 162079, xmax = 194341, ymin = -Inf, ymax = Inf, fill="grey84") +
  annotate("rect", xmin = 249086, xmax = 280528, ymin = -Inf, ymax = Inf, fill="grey84") +
  geom_point(data = dd,
        mapping = aes(y = H2Og, colour = fz),
        alpha = 0.8) +
  annotate("rect", xmin = as.POSIXct("1970-01-01 00:00:01", tz="UTC"), 
           xmax = as.POSIXct("1970-01-01 06:00:00", tz="UTC"), 
           ymin = -Inf, ymax = Inf, fill="grey84") +
  annotate("rect", xmin = as.POSIXct("1970-01-01 21:00:00", tz="UTC"), 
           xmax = as.POSIXct("1970-01-01 23:59:59", tz="UTC"), 
          ymin = -Inf, ymax = Inf, fill="grey84") +
  #geom_ribbon(aes(ymin = lower, ymax = upper, fill = fz, colour = NULL),alpha = 0.2) +
  geom_line()+
  scale_x_time()+
  #ylim(0, 0.35)+
  #scale_colour_manual(name="Treatments",values=cols)+
  #scale_fill_manual(name="Treatments",values=cols)+
  #theme_classic()+
  #coord_polar() +
  theme_minimal()+
  scale_color_viridis_d()
  
RWL_gam

water/RWL_gam
```


```{r}
M3_v1 <- bam(log(EE_kJH) ~ H2O * Sex + s(days, by=tt, bs='cc',k=20)  + s(time_in_D,by=tt, bs="cr",k=40), data = dd, random = list(startexp = ~1, Animal_ID = ~1|startexp), method="REML")

M3_v2 <- bam(log(EE_kJH) ~ H2O * Sex + s(days, time_in_D, by=tt,k=70), data = dd, random = list(startexp = ~1, Animal_ID = ~1|startexp), method="REML")

AIC(M3_v1, M3_v2)

#if the data is big change to bs = 'cr'
#to determine if K has been set too low.
gam.check(M3_v2)

summary(M3_v2)  

draw(M3_v2, residuals = TRUE, scales = "fixed")
plot(M3_v2, page = 1, scheme = 2, shade =T)
plot(M3_v2, scheme = 2)
vis.gam(M3_v2, view = c("days", "time_in_D"),
    theta = 50, n.grid = 50, lwd = 0.4)

#yellow = larger predictions
#red = smaller predictions
    
vis.gam(M3_v2, theta = 120, n.grid = 50, lwd = 0.4)

ds1 <- data_slice(M3, days = evenly(days, n = 100),
    H2O = level(H2O, "no"), Sex = level(Sex, "Female"),tt = level(tt, "no:Female"))

fv1 <- fitted_values(M3, data = ds1, scale = "response")

fv1 |>
    ggplot(aes(x = days, y = fitted)) +
    geom_point(data = dd |>
                 filter(Sex == "Female", H2O == "no"),
        mapping = aes(y = log(EE_kJH)),
        alpha = 0.8, colour = "steelblue") +
    geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2) +
    geom_line() +
    labs(subtitle = "females without water")

#female
ds2 <- data_slice(M3, days = evenly(days, n = 100),
    H2O = evenly(H2O), Sex = level(Sex, "Female")) |>
    mutate(tt = fct_cross(H2O, Sex, keep_empty = TRUE))

fitted_values(M3, data = ds2, scale = "response")|>
    ggplot(aes(x = days, y = fitted, group = H2O)) +
    geom_point(data = dd |> filter(Sex == "Female"),
        mapping = aes(y = log(EE_kJH), colour = H2O),
        alpha = 0.8) +
    geom_ribbon(aes(ymin = lower, ymax = upper, fill = H2O),
        alpha = 0.2) +
    geom_line(aes(colour = H2O))+
  labs(subtitle = "females")

#male
ds2 <- data_slice(M3, days = evenly(days, n = 100),
    H2O = evenly(H2O), Sex = level(Sex, "Male")) |>
    mutate(tt = fct_cross(H2O, Sex, keep_empty = TRUE))

fitted_values(M3, data = ds2, scale = "response")|>
    ggplot(aes(x = days, y = fitted, group = H2O)) +
    geom_point(data = dd |> filter(Sex == "Male"),
        mapping = aes(y = log(EE_kJH), colour = H2O),
        alpha = 0.8) +
    geom_ribbon(aes(ymin = lower, ymax = upper, fill = H2O),
        alpha = 0.2) +
    geom_line(aes(colour = H2O))+
    labs(subtitle = "males")

#all the curves :)
###############################

ds4 <- data_slice(M3_v2, days = evenly(days, n = 100),
                  tt = c("no:Male", "yes:Male", "yes:Female", "no:Female"))

EEgam <- fitted_values(M3_v2, data = ds4) |>
  mutate(fz = factor(tt)) |>
  ggplot(aes(x = days, y = fitted, colour = fz, group = fz)) +
  annotate("rect", xmin = 76032, xmax = 107474, ymin = -Inf, ymax = Inf, fill="grey84") +
  annotate("rect", xmin = 162079, xmax = 194341, ymin = -Inf, ymax = Inf, fill="grey84") +
  annotate("rect", xmin = 249086, xmax = 280528, ymin = -Inf, ymax = Inf, fill="grey84") +
  #geom_point(data=dd, aes(y=H2Omg, colour = grey70, group = grey70, alpha = .1))+
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = fz, colour = NULL),alpha = 0.2) +
  geom_line()+
  scale_x_time()+
  scale_colour_manual(name="Treatments",values=cols)+
  scale_fill_manual(name="Treatments",values=cols)+
  theme_classic()

EE/EEgam
```

```{r}
M4_v1 <- bam(RQ ~ H2O * Sex + s(days, by=tt, bs='cc',k=20)  + s(time_in_D,by=tt, bs="cr",k=40), data = dd, random = list(startexp = ~1, Animal_ID = ~1|startexp), method="REML")

M4_v2 <- bam(RQ ~ H2O * Sex + s(days, time_in_D, by=tt,k=70), data = dd, random = list(startexp = ~1, Animal_ID = ~1|startexp), method="REML")

AIC(M4_v1, M4_v2)

#if the data is big change to bs = 'cr'
#to determine if K has been set too low.
gam.check(M4_v2)

summary(M4_v2)  

draw(M4_v2, residuals = TRUE, scales = "fixed")
plot(M4_v2, page = 1, scheme = 2, shade =T)
plot(M4_v2, scheme = 2)
vis.gam(M4_v2, view = c("days", "time_in_D"),
    theta = 50, n.grid = 50, lwd = 0.4)

#yellow = larger predictions
#red = smaller predictions
    
vis.gam(M4_v2, theta = 120, n.grid = 50, lwd = 0.4)

ds1 <- data_slice(M4, days = evenly(days, n = 100),
    H2O = level(H2O, "no"), Sex = level(Sex, "Female"),tt = level(tt, "no:Female"))

fv1 <- fitted_values(M4, data = ds1, scale = "response")

fv1 |>
    ggplot(aes(x = days, y = fitted)) +
    geom_point(data = dd |>
                 filter(Sex == "Female", H2O == "no"),
        mapping = aes(y = RQ),
        alpha = 0.8, colour = "steelblue") +
    geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2) +
    geom_line() +
    labs(subtitle = "females without water")

#female
ds2 <- data_slice(M4, days = evenly(days, n = 100),
    H2O = evenly(H2O), Sex = level(Sex, "Female")) |>
    mutate(tt = fct_cross(H2O, Sex, keep_empty = TRUE))

fitted_values(M4, data = ds2, scale = "response")|>
    ggplot(aes(x = days, y = fitted, group = H2O)) +
    geom_point(data = dd |> filter(Sex == "Female"),
        mapping = aes(y = RQ, colour = H2O),
        alpha = 0.8) +
    geom_ribbon(aes(ymin = lower, ymax = upper, fill = H2O),
        alpha = 0.2) +
    geom_line(aes(colour = H2O))+
  labs(subtitle = "females")

#male
ds2 <- data_slice(M4, days = evenly(days, n = 100),
    H2O = evenly(H2O), Sex = level(Sex, "Male")) |>
    mutate(tt = fct_cross(H2O, Sex, keep_empty = TRUE))

fitted_values(M4, data = ds2, scale = "response")|>
    ggplot(aes(x = days, y = fitted, group = H2O)) +
    geom_point(data = dd |> filter(Sex == "Male"),
        mapping = aes(y = RQ, colour = H2O),
        alpha = 0.8) +
    geom_ribbon(aes(ymin = lower, ymax = upper, fill = H2O),
        alpha = 0.2) +
    geom_line(aes(colour = H2O))+
    labs(subtitle = "males")

#all the curves :)
###############################

ds4 <- data_slice(M4_v2, days = evenly(days, n = 100),
                  tt = c("no:Male", "yes:Male", "yes:Female", "no:Female"))

rq_gam <- fitted_values(M4_v2, data = ds4) |>
  mutate(fz = factor(tt)) |>
  ggplot(aes(x = days, y = fitted, colour = fz, group = fz)) +
  annotate("rect", xmin = 76032, xmax = 107474, ymin = -Inf, ymax = Inf, fill="grey84") +
  annotate("rect", xmin = 162079, xmax = 194341, ymin = -Inf, ymax = Inf, fill="grey84") +
  annotate("rect", xmin = 249086, xmax = 280528, ymin = -Inf, ymax = Inf, fill="grey84") +
  #geom_point(data=dd, aes(y=H2Omg, colour = grey70, group = grey70, alpha = .1))+
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = fz, colour = NULL),alpha = 0.2) +
  geom_line()+
  scale_x_time()+
  scale_colour_manual(name="Treatments",values=cols)+
  scale_fill_manual(name="Treatments",values=cols)+
  theme_classic()

RQ/rq_gam
```


